
# æ–‡æœ¬å’Œå­—èŠ‚åºåˆ—

> äººç±»ä½¿ç”¨æ–‡æœ¬ï¼Œè®¡ç®—æœºä½¿ç”¨å­—èŠ‚åºåˆ—  
> â€”â€” Esther Nam å’Œ Travis Fischer  "Character Encoding and Unicode in Python"

Python 3 æ˜ç¡®åŒºåˆ†äº†äººç±»å¯è¯»çš„æ–‡æœ¬å­—ç¬¦ä¸²å’ŒåŸå§‹çš„å­—èŠ‚åºåˆ—ã€‚  
éšå¼åœ°æŠŠå­—èŠ‚åºåˆ—è½¬æ¢æˆ Unicode æ–‡æœ¬ï¼ˆçš„è¡Œä¸ºï¼‰å·²æˆè¿‡å»ã€‚

### å­—ç¬¦ä¸ç¼–ç 
å­—ç¬¦çš„æ ‡è¯†ï¼ŒåŠ**ç ä½**ï¼Œæ˜¯ 0~1114111 çš„æ•°å­—ï¼Œåœ¨ Unicode æ ‡å‡†ä¸­ç”¨ 4-6 ä¸ªåå…­è¿›åˆ¶æ•°å­—è¡¨ç¤ºï¼Œå¦‚ A ä¸º U+0041, é«˜éŸ³è°±å·ä¸º U+1D11Eï¼ŒğŸ˜‚ ä¸º U+1F602.  
å­—ç¬¦çš„å…·ä½“è¡¨è¿°å–å†³äºæ‰€ç”¨çš„**ç¼–ç **ã€‚ç¼–ç æ—¶åœ¨ç ä½ä¸å­—èŠ‚åºåˆ—è‡ªå‡è½¬æ¢æ—¶ä½¿ç”¨çš„ç®—æ³•ã€‚  
æŠŠç ä½è½¬æ¢æˆå­—èŠ‚åºåˆ—çš„è¿‡ç¨‹æ˜¯**ç¼–ç **ï¼ŒæŠŠå­—èŠ‚åºåˆ—è½¬æˆç ä½çš„è¿‡ç¨‹æ˜¯**è§£ç **ã€‚

### åºåˆ—ç±»å‹
Python å†…ç½®äº†ä¸¤ç§åŸºæœ¬çš„äºŒè¿›åˆ¶åºåˆ—ç±»å‹ï¼šä¸å¯å˜çš„ `bytes` å’Œå¯å˜çš„ `bytearray`


```python
# åŸºæœ¬çš„ç¼–ç 
content = "SÃ£o Paulo"
for codec in ["utf_8", "utf_16"]:
    print(codec, content.encode(codec))

# UnicodeEncodeError
try:
    content.encode('cp437')
except UnicodeEncodeError as e:
    print(e)

# å¿½ç•¥æ— æ³•ç¼–ç çš„å­—ç¬¦
print(content.encode('cp437', errors='ignore'))
# æŠŠæ— æ³•ç¼–ç çš„å­—ç¬¦æ›¿æ¢æˆ ?
print(content.encode('cp437', errors='replace'))
# æŠŠæ— æ³•ç¼–ç çš„å­—ç¬¦æ›¿æ¢æˆ xml å®ä½“
print(content.encode('cp437', errors='xmlcharrefreplace'))

# è¿˜å¯ä»¥è‡ªå·±è®¾ç½®é”™è¯¯å¤„ç†æ–¹å¼
# https://docs.python.org/3/library/codecs.html#codecs.register_error
```

    utf_8 b'S\xc3\xa3o Paulo'
    utf_16 b'\xff\xfeS\x00\xe3\x00o\x00 \x00P\x00a\x00u\x00l\x00o\x00'
    'charmap' codec can't encode character '\xe3' in position 1: character maps to <undefined>
    b'So Paulo'
    b'S?o Paulo'
    b'S&#227;o Paulo'



```python
# åŸºæœ¬çš„è§£ç 
# å¤„ç† UnicodeDecodeError
octets = b'Montr\xe9al'
print(octets.decode('cp1252'))
print(octets.decode('iso8859_7'))
print(octets.decode('koi8_r'))
try:
    print(octets.decode('utf-8'))
except UnicodeDecodeError as e:
    print(e)

# å°†é”™è¯¯å­—ç¬¦æ›¿æ¢æˆ ï¿½ (U+FFFD)
octets.decode('utf-8', errors='replace')
```


```python
# Python3 å¯ä»¥ä½¿ç”¨é ASCII åç§°
SÃ£o = 'Paulo'
# ä½†æ˜¯ä¸èƒ½ç”¨ Emojiâ€¦
```

å¯ä»¥ç”¨ `chardet` æ£€æµ‹å­—ç¬¦æ‰€ä½¿ç”¨çš„ç¼–ç 

BOMï¼šå­—èŠ‚åºæ ‡è®° (byte-order mark)ï¼š  
`\ufffe` ä¸ºå­—èŠ‚åºæ ‡è®°ï¼Œæ”¾åœ¨æ–‡ä»¶å¼€å¤´ï¼ŒUTF-16 ç”¨å®ƒæ¥è¡¨ç¤ºæ–‡æœ¬ä»¥å¤§ç«¯è¡¨ç¤º(`\xfe\xff`)è¿˜æ˜¯å°ç«¯è¡¨ç¤º(`\xff\xfe`)ã€‚  
UTF-8 ç¼–ç å¹¶ä¸éœ€è¦ BOMï¼Œä½†æ˜¯å¾®è½¯è¿˜æ˜¯ç»™å®ƒåŠ äº† BOMï¼Œéå¸¸çƒ¦äººã€‚

### å¤„ç†æ–‡æœ¬æ–‡ä»¶
å¤„ç†æ–‡æœ¬æ–‡ä»¶çš„æœ€ä½³å®è·µæ˜¯â€œä¸‰æ˜æ²»â€ï¼šè¦å°½æ—©åœ°æŠŠè¾“å…¥çš„å­—èŠ‚åºåˆ—è§£ç æˆå­—ç¬¦ä¸²ï¼Œå°½é‡æ™šåœ°å¯¹å­—ç¬¦ä¸²è¿›è¡Œç¼–ç è¾“å‡ºï¼›åœ¨å¤„ç†é€»è¾‘ä¸­åªå¤„ç†å­—ç¬¦ä¸²å¯¹è±¡ï¼Œä¸åº”è¯¥å»ç¼–ç æˆ–è§£ç ã€‚  
é™¤éæƒ³åˆ¤æ–­ç¼–ç ï¼Œå¦åˆ™ä¸è¦å†äºŒè¿›åˆ¶æ¨¡å¼ä¸­æ‰“å¼€æ–‡æœ¬æ–‡ä»¶ï¼›å³ä¾¿å¦‚æ­¤ï¼Œä¹Ÿåº”è¯¥ä½¿ç”¨ `Chardet`ï¼Œè€Œä¸æ˜¯é‡æ–°å‘æ˜è½®å­ã€‚  
å¸¸è§„ä»£ç åªåº”è¯¥ä½¿ç”¨äºŒè¿›åˆ¶æ¨¡å¼æ‰“å¼€äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ¯”å¦‚å›¾åƒã€‚

### é»˜è®¤ç¼–ç 
å¯ä»¥ä½¿ç”¨ `sys.getdefaultincoding()` è·å–ç³»ç»Ÿé»˜è®¤ç¼–ç ï¼›  
Linux çš„é»˜è®¤ç¼–ç ä¸º `UTF-8`ï¼ŒWindows ç³»ç»Ÿä¸­ä¸åŒè¯­è¨€è®¾ç½®ä½¿ç”¨çš„ç¼–ç ä¹Ÿä¸åŒï¼Œè¿™å¯¼è‡´äº†æ›´å¤šçš„é—®é¢˜ã€‚  
`locale.getpreferredencoding()` è¿”å›çš„ç¼–ç æ˜¯æœ€é‡è¦çš„ï¼šè¿™æ˜¯æ‰“å¼€æ–‡ä»¶çš„é»˜è®¤ç¼–ç ï¼Œä¹Ÿæ˜¯é‡å®šå‘åˆ°æ–‡ä»¶çš„ `sys.stdout/stdin/stderr` çš„é»˜è®¤ç¼–ç ã€‚ä¸è¿‡è¿™ä¸ªç¼–ç åœ¨æŸäº›ç³»ç»Ÿä¸­æ˜¯å¯ä»¥æ”¹çš„â€¦  
æ‰€ä»¥ï¼Œå…³äºç¼–ç é»˜è®¤å€¼çš„æœ€ä½³å»ºè®®æ˜¯ï¼šåˆ«ä¾èµ–é»˜è®¤å€¼ã€‚

### Unicode ç¼–ç æ–¹æ¡ˆ
```python
a = 'cafÃ©'
b = 'cafe\u0301'
print(a, b)                       # cafÃ© cafeÌ
print(ascii(a), ascii(b))         # 'caf\xe9' 'cafe\u0301'
print(len(a), len(b), a == b)     # 4 5 False
```

åœ¨ Unicode æ ‡å‡†ä¸­ï¼ŒÃ© å’Œ e\u0301 è¿™æ ·çš„åºåˆ—å«â€œæ ‡å‡†ç­‰ä»·ç‰©â€ï¼Œåº”ç”¨ç¨‹åºåº”å°†å®ƒè§†ä¸ºç›¸åŒçš„å­—ç¬¦ã€‚ä½† Python çœ‹åˆ°çš„æ˜¯ä¸åŒçš„ç ä½åºåˆ—ï¼Œå› æ­¤åˆ¤æ–­ä¸¤è€…ä¸ç›¸åŒã€‚  
æˆ‘ä»¬å¯ä»¥ç”¨ `unicodedata.normalize` å°† Unicode å­—ç¬¦ä¸²è§„èŒƒåŒ–ã€‚æœ‰å››ç§è§„èŒƒæ–¹å¼ï¼šNFC, NFD, NFKC, NFKD

NFC ä½¿ç”¨æœ€å°‘çš„ç ä½æ„æˆç­‰ä»·çš„å­—ç¬¦ä¸²ï¼Œè€Œ NFD ä¼šæŠŠç»„åˆå­—ç¬¦åˆ†è§£æˆåŸºå­—ç¬¦å’Œå•ç‹¬çš„ç»„åˆå­—ç¬¦ã€‚  
NFKC å’Œ NFKD æ˜¯å‡ºäºå…¼å®¹æ€§è€ƒè™‘ï¼Œåœ¨åˆ†è§£æ—¶ä¼šå°†å­—ç¬¦æ›¿æ¢æˆâ€œå…¼å®¹å­—ç¬¦â€ï¼Œè¿™ç§æƒ…å†µä¸‹ä¼šæœ‰æ ¼å¼æŸå¤±ã€‚  
å…¼å®¹æ€§æ–¹æ¡ˆå¯èƒ½ä¼šæŸå¤±æˆ–æ›²è§£ä¿¡æ¯ï¼ˆå¦‚ "4Â²" ä¼šè¢«è½¬æ¢æˆ "42"ï¼‰ï¼Œä½†å¯ä»¥ä¸ºæœç´¢å’Œç´¢å¼•æä¾›ä¾¿åˆ©çš„ä¸­é—´è¡¨è¿°ã€‚

> ä½¿ç”¨ NFKC å’Œ NFKC è§„èŒƒåŒ–å½¢å¼æ—¶è¦å°å¿ƒï¼Œè€Œä¸”åªèƒ½åœ¨ç‰¹æ®Šæƒ…å†µä¸­ä½¿ç”¨ï¼Œä¾‹å¦‚æœç´¢å’Œç´¢å¼•ï¼Œè€Œä¸èƒ½ç”¨æˆ·æŒä¹…å­˜å‚¨ï¼Œå› ä¸ºè¿™ä¸¤ç§è½¬æ¢ä¼šå¯¼è‡´æ•°æ®æŸå¤±ã€‚


```python
from unicodedata import normalize, name
# Unicode ç ä½
a = 'cafÃ©'
b = 'cafe\u0301'
print(a, b)
print(ascii(a), ascii(b))
print(len(a), len(b), a == b)

## NFC å’Œ NFD
print(len(normalize('NFC', a)), len(normalize('NFC', b)))
print(len(normalize('NFD', a)), len(normalize('NFD', b)))
print(len(normalize('NFC', a)) == len(normalize('NFC', b)))

print('-' * 15)
# NFKC & NFKD
s = '\u00bd'
l = [s, normalize('NFKC', s),  normalize('NFKD', s)]
print(*l)
print(*map(ascii, l))
micro = 'Î¼'
l = [s, normalize('NFKC', micro)]
print(*l)
print(*map(ascii, l))
print(*map(name, l), sep='; ')
```

### Unicode æ•°æ®åº“
`unicodedata` åº“ä¸­æä¾›äº†å¾ˆå¤šå…³äº Unicode çš„æ“ä½œåŠåˆ¤æ–­åŠŸèƒ½ï¼Œæ¯”å¦‚æŸ¥çœ‹å­—ç¬¦åç§°çš„ `name`ï¼Œåˆ¤æ–­æ•°å­—å¤§å°çš„ `numric` ç­‰ã€‚  
æ–‡æ¡£è§ <https://docs.python.org/3.7/library/unicodedata.html>.


```python
import unicodedata
print(unicodedata.name('Â½'))
print(unicodedata.numeric('Â½'), unicodedata.numeric('å…'))
```

    VULGAR FRACTION ONE HALF
    0.5 30.0



```python
# å¤„ç†é¬¼ç¬¦ï¼šæŒ‰å­—èŠ‚åºå°†æ— æ³•å¤„ç†çš„å­—èŠ‚åºåˆ—ä¾åºæ›¿æ¢æˆ \udc00 - \udcff ä¹‹é—´çš„ç ä½
x = 'digits-of-Ï€'
s = x.encode('gb2312')
print(s)                                              # b'digits-of-\xa6\xd0'
ascii_err = s.decode('ascii', 'surrogateescape')
print(ascii_err)                                      # 'digits-of-\udca6\udcd0'
print(ascii_err.encode('ascii', 'surrogateescape'))   # b'digits-of-\xa6\xd0'
```
